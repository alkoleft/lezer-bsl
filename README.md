# lezer-bsl

Грамматика и парсер 1C (BSL) на основе [Lezer](https://lezer.codemirror.net/). Поддерживает синтаксис языка программирования 1С:Предприятие. Парсер предназначен для использования в веб-приложениях и браузерных редакторах кода.

**О Lezer**: Lezer — это парсер-генератор от команды CodeMirror, предназначенный для создания эффективных парсеров с поддержкой инкрементального парсинга. Это делает его идеальным выбором для интеграции в веб-редакторы кода, где требуется быстрое обновление синтаксического дерева при каждом изменении текста. Парсер генерируется из декларативной грамматики и предоставляет структурированное дерево разбора (AST) для дальнейшей обработки кода.

## Содержание

- [Особенности](#особенности)
- [Установка](#установка)
- [Использование](#использование)
- [Поддерживаемые конструкции](#поддерживаемые-конструкции)
- [Производительность](#производительность)
- [Разработка](#разработка)
- [Структура проекта](#структура-проекта)

## Особенности

- ✅ Парсинг BSL кода с поддержкой основных конструкций языка
- ✅ Поддержка русских и английских ключевых слов (регистронезависимо)
- ✅ Инкрементальный парсинг для эффективного обновления дерева при изменениях
- ✅ Визуализация дерева парсинга в веб-интерфейсе
- ✅ Полная поддержка выражений, операторов и структур управления
- ✅ Поддержка комментариев и директив препроцессора

## Установка

```bash
npm install
```

или

```bash
yarn install
```

## Использование

### Базовое использование

```typescript
import { LezerBslParser } from './src/parser/LezerBslParser'

const parser = new LezerBslParser()
const code = `
Процедура Тест()
    Перем а = 1;
    Возврат а + 2;
КонецПроцедуры
`

const tree = parser.parse(code)
// Работа с деревом парсинга
```

### Инкрементальный парсинг

Для эффективного обновления при изменениях в редакторе:

```typescript
const parser = new LezerBslParser()
let tree = parser.parse(initialCode)

// При изменении кода
const changes = [
  {
    rangeOffset: 10,
    rangeLength: 5,
    text: "НовыйТекст"
  }
]

tree = parser.update(newCode, changes)
```

### Веб-интерфейс

Запустите демо-приложение для визуализации дерева парсинга:

```bash
npm run dev
```

Откройте браузер по адресу, указанному в консоли (обычно `http://localhost:5173`).

## Поддерживаемые конструкции

### Объявления

- Процедуры и функции
- Параметры (с модификатором `Знач`/`Val`)
- Переменные (`Перем`/`Var`)
- Экспортные методы (`Экспорт`/`Export`)

### Структуры управления

- Условные операторы: `Если`/`If`, `ИначеЕсли`/`ElsIf`, `Иначе`/`Else`
- Циклы: `Пока`/`While`, `Для`/`For` (с `Каждого`/`Each` и `По`/`To`)
- Обработка исключений: `Попытка`/`Try`, `Исключение`/`Except`
- `Возврат`/`Return`, `ВызватьИсключение`/`Raise`

### Выражения

- Арифметические операции: `+`, `-`, `*`, `/`
- Операторы сравнения: `=`, `<>`, `>`, `<`, `>=`, `<=`
- Логические операции: `И`/`AND`, `ИЛИ`/`OR`, `НЕ`/`NOT`
- Вызовы методов и доступ к свойствам
- Индексация массивов
- Литералы: числа, строки, `Истина`/`True`, `Ложь`/`False`, `Неопределено`/`Undefined`
- Создание объектов: `Новый`/`New`

### Другие возможности

- Однострочные комментарии (`//`)
- Директивы препроцессора (`#`)
- Регистронезависимые ключевые слова

## Производительность

Парсер демонстрирует высокую производительность как при полном парсинге, так и при инкрементальных обновлениях. Ниже представлены результаты бенчмарков для модулей различного размера:

### Модуль: small (93 символов)

| Тест | Операций/сек | Среднее время (ms) | p75 (ms) | p99 (ms) |
|------|-------------|-------------------|----------|----------|
| Полный парсинг | 32,679.15 | 0.0306 | 0.0297 | 0.0595 |
| Инкрементальное обновление - вставка | 8,905.86 | 0.1123 | 0.1306 | 0.7448 |
| Инкрементальное обновление - удаление | 38,448.97 | 0.0260 | 0.0248 | 0.0531 |

### Модуль: medium (652 символов)

| Тест | Операций/сек | Среднее время (ms) | p75 (ms) | p99 (ms) |
|------|-------------|-------------------|----------|----------|
| Полный парсинг | 7,014.13 | 0.1426 | 0.1437 | 0.2633 |
| Инкрементальное обновление - вставка | 4,924.59 | 0.2031 | 0.2153 | 0.7484 |
| Инкрементальное обновление - удаление | 8,326.13 | 0.1201 | 0.1264 | 0.2177 |

### Модуль: large (3420 символов)

| Тест | Операций/сек | Среднее время (ms) | p75 (ms) | p99 (ms) |
|------|-------------|-------------------|----------|----------|
| Полный парсинг | 1,301.79 | 0.7682 | 0.7926 | 1.2203 |
| Инкрементальное обновление - вставка | 1,173.44 | 0.8522 | 0.8845 | 2.0003 |
| Инкрементальное обновление - удаление | 1,341.47 | 0.7455 | 0.7731 | 1.2336 |

### Модуль: very-large (9433 символов)

| Тест | Операций/сек | Среднее время (ms) | p75 (ms) | p99 (ms) |
|------|-------------|-------------------|----------|----------|
| Полный парсинг | 518.98 | 1.9269 | 2.0324 | 3.2636 |
| Инкрементальное обновление - вставка | 1,325.66 | 0.7543 | 0.8249 | 1.6290 |
| Инкрементальное обновление - удаление | 1,250.02 | 0.8000 | 0.8077 | 1.4107 |

Для запуска бенчмарков используйте:

```bash
npm run test:benchmark
```

## Разработка

### Генерация парсера

После изменения грамматики в `src/bsl.grammar`:

```bash
npm run gen-lezer-bsl
```

### Запуск тестов

```bash
npm test
```

### Сборка

```bash
npm run build
```

### Предпросмотр сборки

```bash
npm run preview
```

## Структура проекта

```
lezer-bsl/
├── src/
│   ├── bsl.grammar          # Грамматика Lezer для BSL
│   ├── main.ts              # Веб-интерфейс для визуализации
│   └── parser/
│       ├── bslParser.ts     # Сгенерированный парсер (не редактировать)
│       ├── bslParser.terms.ts
│       └── LezerBslParser.ts # Обёртка с инкрементальным парсингом
├── tests/
│   └── parser.test.ts       # Тесты парсера
├── index.html               # HTML для демо-приложения
└── package.json
```
